{% extends "base.html" %}
{% block content %}

{% if show_onboarding %}
<div class="modal fade show d-block" id="onboardingModal" tabindex="-1" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Welcome to Your Expense Tracker!</h5>
      </div>
      <div class="modal-body">
        <ul>
          <li>Hover on any card/widget for light animation! No card increases in size.</li>
          <li>Switch to dark mode or themes using the toggle on the top right.</li>
          <li>Use <strong>tags</strong> for flexible expense filtering.</li>
          <li>Set budgets to get alerts on overspending.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.href='/?dismiss_onboarding=1'">Let's Go!</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="container mt-4">
  <h2 class="mb-4">‚ö° Quick Actions</h2>
  <div class="row mb-4">
    <div class="col-md-3 mb-2">
      <a href="/add" class="btn btn-primary btn-lg w-100">‚ûï Add Expense</a>
    </div>
    <div class="col-md-3 mb-2">
      <a href="/add_income" class="btn btn-success btn-lg w-100">üí∞ Add Income</a>
    </div>
    <div class="col-md-3 mb-2">
      <a href="/expenses" class="btn btn-info btn-lg w-100">üìä View Expenses</a>
    </div>
    <div class="col-md-3 mb-2">
      <a href="/add_category" class="btn btn-warning btn-lg w-100">üè∑Ô∏è Add Category</a>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-12">
      <a href="/print_report" class="btn btn-secondary btn-lg w-100">üìÑ Print Report</a>
    </div>
  </div>

  {% if alert_budget %}
  <div class="alert alert-warning" role="alert">
    <strong>Alert:</strong> You are near/over your monthly budget!
  </div>
  {% endif %}

  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">Today</h6>
          <h3 class="card-title text-success">‚Çπ{{ stats.today }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">This Week</h6>
          <h3 class="card-title text-primary">‚Çπ{{ stats.week }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">This Month</h6>
          <h3 class="card-title text-info">‚Çπ{{ stats.month }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">Total Income (Month)</h6>
          <h3 class="card-title text-danger">‚Çπ{{ stats.income }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">Top Category</h6>
          <h5 class="card-title">{{ stats.max_cat_name }}</h5>
          <p class="card-text">‚Çπ{{ stats.max_cat_amt }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2 text-muted">Budget (Month)</h6>
          <h5 class="card-title">{% if stats.budget > 0 %}‚Çπ{{ stats.budget }}{% else %}-{% endif %}</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Spending Trend (This Month)</h5>
          <div id="trendChartContainer">
            <canvas id="trendChart" height="80"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Category Breakdown</h5>
          <div class="text-center mb-3">
            <button class="btn btn-primary btn-sm" id="pieBtn">Pie</button>
            <button class="btn btn-outline-primary btn-sm" id="barBtn">Bar</button>
          </div>
          <div id="categoryChartContainer">
            <canvas id="categoryChart" height="80"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Categories Section -->
  <div class="row mb-4">
    <div class="col-12">
      <h4>Categories</h4>
      <div class="d-flex flex-wrap">
        {% for cat in categories %}
        <div class="badge bg-secondary m-1 p-2">
          {{ cat.icon }} {{ cat.name }}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Recent Expenses -->
  <div class="row mb-4">
    <div class="col-12">
      <h4>Recent Expenses</h4>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Tags</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in expenses %}
            {% set cat = categories|selectattr("id","equalto",expense.category_id)|first %}
            <tr>
              <td>{{ expense.date.strftime("%Y-%m-%d") }}</td>
              <td>{{ cat.icon }} {{ cat.name }}</td>
              <td>{{ expense.description }}</td>
              <td>‚Çπ{{ expense.amount }}</td>
              <td>{{ expense.tags }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recent Incomes -->
  <div class="row mb-4">
    <div class="col-12">
      <h4>Recent Incomes</h4>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Source</th>
              <th>Amount</th>
              <th>Tags</th>
              <th>Recurring</th>
            </tr>
          </thead>
          <tbody>
            {% for income in incomes %}
            <tr>
              <td>{{ income.date.strftime("%Y-%m-%d") }}</td>
              <td>{{ income.source }}</td>
              <td>‚Çπ{{ income.amount }}</td>
              <td>{% if income.tags %}{{ income.tags.split(",") | join(", ") }}{% else %}-{% endif %}</td>
              <td>{% if income.recurring %}Yes{{ " (" + income.recurring + ")" if income.recurring != "Yes" else "" }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing charts...');
    
    // Prevent Chart.js from using the buggy generateLabels
    if (window.Chart && Chart.defaults && Chart.defaults.plugins && Chart.defaults.plugins.legend) {
        // Override the problematic function
        Chart.defaults.plugins.legend.labels.generateLabels = function(chart) {
            return [];
        };
    }
    
    try {
        // Get data from Flask
        const trendLabels = {{ trend_labels|tojson|safe }};
        const trendDataValues = {{ trend_data|tojson|safe }};
        const categoryData = {{ category_chart_data|tojson|safe }};

        console.log('Chart data loaded:', { trendLabels, trendDataValues, categoryData });

        // ===== TREND CHART =====
        const trendCanvas = document.getElementById('trendChart');
        const trendContainer = document.getElementById('trendChartContainer');
        
        if (trendCanvas && trendContainer) {
            const hasTrendData = trendLabels && trendLabels.length > 0 && 
                                trendDataValues && trendDataValues.length > 0;

            if (hasTrendData) {
                try {
                    const validData = trendDataValues.map(val => {
                        const num = parseFloat(val);
                        return isNaN(num) ? 0 : num;
                    });

                    new Chart(trendCanvas, {
                        type: 'line',
                        data: {
                            labels: trendLabels,
                            datasets: [{
                                label: 'Spending',
                                data: validData,
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: 'Daily Spending (‚Çπ)'
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { callback: v => '‚Çπ' + v }
                                }
                            }
                        }
                    });
                    
                    console.log('‚úì Trend chart created');
                } catch (error) {
                    console.error('‚úó Trend chart error:', error);
                    trendContainer.innerHTML = '<div class="alert alert-warning text-center"><strong>‚ö†Ô∏è Chart Display Issue</strong><br><small>Unable to render trend chart.</small></div>';
                }
            } else {
                trendContainer.innerHTML = '<div class="alert alert-secondary text-center"><strong>üìä No spending data yet</strong><br><small>Add your first expense!</small><br><a href="/add" class="btn btn-primary btn-sm mt-2">‚ûï Add Expense</a></div>';
            }
        }

        // ===== CATEGORY CHART =====
        let categoryChart = null;

        function renderCategoryChart(type) {
            const container = document.getElementById('categoryChartContainer');
            
            try {
                if (!categoryData || categoryData.length === 0) {
                    container.innerHTML = '<div class="alert alert-secondary text-center"><strong>üìà No categories yet</strong><br><small>Add an expense!</small><br><a href="/add" class="btn btn-primary btn-sm mt-2">‚ûï Add Expense</a></div>';
                    return;
                }

                const categories = categoryData.map(i => i.name || 'Unknown');
                const amounts = categoryData.map(i => parseFloat(i.total) || 0);

                if (categoryChart) {
                    categoryChart.destroy();
                }

                container.innerHTML = '<canvas id="categoryChart" height="80"></canvas>';
                const canvas = document.getElementById('categoryChart');

                categoryChart = new Chart(canvas, {
                    type: type,
                    data: {
                        labels: categories,
                        datasets: [{
                            data: amounts,
                            backgroundColor: type === 'pie' ? 
                                ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#E7E9ED','#C9CBCF'] : 
                                '#36A2EB'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { 
                                display: type === 'pie',
                                position: 'bottom'
                            }
                        },
                        scales: type === 'bar' ? {
                            y: { 
                                beginAtZero: true,
                                ticks: { callback: v => '‚Çπ' + v }
                            }
                        } : {}
                    }
                });
                
                console.log('‚úì Category chart:', type);
            } catch (error) {
                console.error('‚úó Category chart error:', error);
                container.innerHTML = '<div class="alert alert-danger text-center">Error: ' + error.message + '</div>';
            }
        }

        // Initial render
        if (categoryData && categoryData.length > 0) {
            renderCategoryChart('pie');
        }

        // Toggle buttons
        const pieBtn = document.getElementById('pieBtn');
        const barBtn = document.getElementById('barBtn');

        if (pieBtn) {
            pieBtn.onclick = function() {
                renderCategoryChart('pie');
                pieBtn.className = 'btn btn-primary btn-sm';
                barBtn.className = 'btn btn-outline-primary btn-sm';
            };
        }

        if (barBtn) {
            barBtn.onclick = function() {
                renderCategoryChart('bar');
                barBtn.className = 'btn btn-primary btn-sm';
                pieBtn.className = 'btn btn-outline-primary btn-sm';
            };
        }

        console.log('‚úì Initialization complete');
        
    } catch (error) {
        console.error('‚úó Fatal error:', error);
    }
});
</script>

{% endblock %}

