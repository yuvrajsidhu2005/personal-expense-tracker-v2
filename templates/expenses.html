{% extends "base.html" %}
{% block content %}
<div class="dashboard-bg pb-5" style="min-height:93vh;">
  <div class="container-fluid">
    <div class="row justify-content-center g-4">
      <div class="col-12">
        <div class="card shadow mb-5 fade-in p-3 dashboard-widget">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold" style="color:#1565c0;">All Expenses</h2>
            <span>
              <a id="exportBtn" class="btn btn-outline-success btn-sm me-2" href="{{ url_for('export_expenses') }}">Export CSV</a>
              <a id="printBtn" class="btn btn-outline-secondary btn-sm" href="{{ url_for('print_report') }}">Print Report</a>
            </span>
          </div>
          <div class="mb-3 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm filter-preset" data-type="month">This Month</button>
            <button type="button" class="btn btn-outline-primary btn-sm filter-preset" data-type="lastmonth">Last Month</button>
            <button type="button" class="btn btn-outline-primary btn-sm filter-preset" data-type="year">This Year</button>
            <button type="button" class="btn btn-outline-primary btn-sm filter-preset" data-type="today">Today</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilter">Clear</button>
          </div>
          <form class="row g-2 mb-3" method="GET" action="{{ url_for('search') }}" id="expensesFiltersForm">
            <div class="col-md-4">
              <select class="form-select" name="category" id="filterCategory">
                <option value="">All Categories</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <input type="date" class="form-control" name="date_from" id="filterFrom" placeholder="From">
            </div>
            <div class="col-md-3">
              <input type="date" class="form-control" name="date_to" id="filterTo" placeholder="To">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
          </form>
          <div class="mb-2 d-flex justify-content-end gap-2">
            <input type="text" class="form-control w-auto" id="searchDesc" placeholder="Search Description..." style="max-width:220px;">
            <input type="search" class="form-control w-auto tag-input" id="searchTags" placeholder="Tags (#food, #travel...)" style="max-width:160px;">
          </div>
          <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle w-100 shadow-sm" id="expTable">
              <thead>
                <tr>
                  <th id="sortDate" class="sortable">Date ▲</th>
                  <th>Category</th>
                  <th id="sortDesc" class="sortable">Description</th>
                  <th id="sortAmount" class="sortable">Amount</th>
                  <th>Tags</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
              {% for expense in expenses %}
                <tr class="expense-row-animate">
                  <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                  <td>
                    {% set cat = categories | selectattr("id", "equalto", expense.category_id) | first %}
                    <span title="{{ cat.name }}">{{ cat.icon }}</span> {{ cat.name }}
                  </td>
                  <td>{{ expense.description }}</td>
                  <td>₹{{ expense.amount }}</td>
                  <td>
                    {% if expense.tags %}
                      {% for tag in expense.tags.split(",") %}
                        <span class="badge rounded-pill bg-primary tagchip">{{ tag }}</span>
                      {% endfor %}
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-warning me-2">Edit</a>
                    <form action="{{ url_for('delete_expense', expense_id=expense.id) }}" method="POST" style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- Confirm Delete Modal is now handled inline for accessibility -->
      </div>
    </div>
  </div>
</div>
{% endblock %}
